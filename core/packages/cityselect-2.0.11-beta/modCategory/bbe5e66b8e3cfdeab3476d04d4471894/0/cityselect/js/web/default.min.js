!function(t,e){"use strict";var n,i,s,o=[].indexOf||function(t){for(var e=0,n=this.length;e<n;e++)if(e in this&&this[e]===t)return e;return-1},a={}.hasOwnProperty,c=[].slice,r=function(t,e){return function(){return t.apply(e,arguments)}},u=function(t,e){function n(){this.constructor=t}for(var i in e)a.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},l=function(t,e){if("function"==typeof t)return t.apply(e,Array.prototype.slice.call(arguments,2));if("object"==typeof t)for(var n in t)if(t.hasOwnProperty(n)&&!1===t[n].apply(e,Array.prototype.slice.call(arguments,2)))return!1;return!0},p=function(t){return t.replace(/(-|\.)(\w)/g,function(t,e){return e.toUpperCase()})},d=function(t){return t.replace(/[A-Z]/g,function(t,e){return(0==e?"":"-")+t.toLowerCase()})},h=function(e,n){var i,s;return void 0===n&&(n=t.fn.cityselect.defaults.ns),i=p(n),s=e.data(i)||{},t.each(e.data(),function(t,e){if(0===t.indexOf(i)){var n=d(t.replace(i,""));n.length>0&&(s[n]=e)}}),s},f=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})},y=function(t,e){for(var n in e)if(e[n]==t)return!0;return!1},v=v||{};n=["extended","included"],function(){function t(){}t.extend=function(t){var e,i,s;for(e in t)s=t[e],o.call(n,e)<0&&(this[e]=s);return null!=(i=t.extended)&&i.apply(this),this},t.include=function(t){var e,i,s;for(e in t)s=t[e],o.call(n,e)<0&&(this.prototype[e]=s);return null!=(i=t.included)&&i.apply(this),this}}(),(i=function(n,i){this.defaults=t.fn.cityselect.defaults,this.selectors=t.fn.cityselect.selectors,this.template=t.fn.cityselect.template,this.$body=t("body"),this.$element=t(n),this.$parent=this.$element.closest(this.selectors.parent),this.$parent.length<1&&(this.$parent=t("body")),this.element="",this.options=t.extend(!0,{},h(this.$parent),i),this.data=t.extend(!0,{ctx:e.ctx,action:""},h(this.$parent,"data"),h(this.$element,"data"))}).prototype={constructor:i,init:function(){this.processSuccess=r(this.processSuccess,this),this.processFailure=r(this.processFailure,this),this.showOutput=r(this.showOutput,this),this.hideOutput=r(this.hideOutput,this),this.setAction=r(this.setAction,this)},getNamespace:function(){var t,e;return e=arguments[0],t=2<=arguments.length?c.call(arguments,1):[],this.defaults.ns+" "+this.defaults.ns+(e||"")+" "+t.join(" ")},getSelector:function(){var t,e;return e=arguments[0],t=2<=arguments.length?c.call(arguments,1):[],"."+this.defaults.ns+"."+this.defaults.ns+(e||"")+t.join(".")},getContent:function(){this.showSpinner(),t.ajax({url:e.actionUrl,type:"post",dataType:"json",cache:!1,data:this.data}).done(function(t){return function(e){t.hideSpinner(),t.processSuccess(e)}}(this)).fail(function(t){return function(e){t.hideSpinner(),t.processFailure(e)}}(this))},createSpinner:function(){return t('<div class="'+this.getNamespace("-spinner")+'"></div>')},showSpinner:function(){if(this.defaults.spinner)return this.$spinner=this.$spinner||this.createSpinner(),this.$body.append(this.$spinner),this.$spinner.show()},hideSpinner:function(){if(this.$spinner)return this.$spinner.remove()},processSuccess:function(e){var n,i;if(n=t.Event(t.fn.cityselect.CONTENT_SUCCESS),this.$element.trigger(n,e),!n.isDefaultPrevented())return e.success||((i=e.message)||(i="error unknown"),e.data.output||(e.data.output=i)),this.showOutput(e)},processFailure:function(e){var n;if(n=t.Event(t.fn.cityselect.CONTENT_FAILURE),this.$element.trigger(n,e),!n.isDefaultPrevented())return e.responseJSON||"error unknown",this.hideOutput(e)},showOutput:function(e){return setTimeout(function(){return l(this.methodActions.show,this),this.$output}.bind(this),t.fn.cityselect.defaults.timeout)},hideOutput:function(e){return setTimeout(function(){return l(this.methodActions.hide,this),this.$output}.bind(this),t.fn.cityselect.defaults.timeout)},setAction:function(n){this.showSpinner(),t.ajax({url:e.actionUrl,type:"post",dataType:"json",cache:!1,data:t.extend(!0,this.data,{action:this.element+"/"+n})}).done(function(t){return function(e){t.hideSpinner(),t.hideOutput(e)}}(this)).fail(function(t){return function(e){t.hideSpinner(),t.hideOutput(e)}}(this))}},s=function(e){function n(e,n){i.prototype.constructor.call(this,e,n),this.element="settlement",this.data=t.extend(!0,this.data,{action:this.element+"/get"}),this.methodActions=t.fn.cityselect.methodActions.SettlementPopover}return u(n,i),n.prototype.createTarget=function(){var e=t('<div class="'+this.getNamespace("-target")+'"></div>');e.prop("id",f()),e.addClass("popover popover-default"),e.append('<div class="arrow"></div>');var n=t('<div class="popover-title"></div>'),i=t('<span class="close pull-right" data-dismiss="popover-x">&times;</span><span class="tm-title">Title</span>');return n.append(i),i.click(this.hideOutput),t(document).click(function(n){e.is(":hidden")||t(n.target).closest("#"+e.prop("id")).length||(i.click(),event.stopPropagation())}),e.append(n),e.append('<div class="popover-content"></div>'),e.append('<div class="popover-footer"></div>'),e.appendTo("body")},n.prototype.createButton=function(e){var n=t('<button class="btn"></button>');return n.prop("id",e.id),n.data("button",e),void 0!==e.icon&&""!==t.trim(e.icon)&&n.append(this.createButtonIcon(e.icon)),void 0!==e.label&&n.append(e.label),void 0!==e.title&&n.attr("title",e.title),void 0!==e.cssClass&&""!==t.trim(e.cssClass)?n.addClass(e.cssClass):n.addClass("btn-default"),"object"==typeof e.data&&e.data.constructor==={}.constructor&&t.each(e.data,function(t,e){n.attr("data-"+t,e)}),n.on("click",{QuickView:this,$button:n,button:e},function(t){var e=t.data.QuickView,n=t.data.$button,i=n.data("button");if(i.autospin&&n.toggleSpin(!0),"function"==typeof i.action)return i.action.call(n,e,t)}),void 0!==e.enabled&&n.toggleEnable(e.enabled),n},n.prototype.getButtons=function(){var e,n;return e=[],this.defaults.buttons?(this.BPopoverOptions.buttons&&jQuery.each(this.BPopoverOptions.buttons,function(i){return function(s,o){"string"==typeof o?n=i.BPopoverOptions[o]||{}:o=(n=o||{}).action||"",n=t.extend({},{label:i.defaults.msg[o]||o,cssClass:i.getNamespace("-"+i.defaults.cls[o],i.defaults.ns+"-action"),action:o,citySelect:i},n),e.push(n)}}(this)),e):e},n.prototype.createButtons=function(){var e,n;return(e=this.getButtons()).length>0&&((n=t("<div></div>")).addClass(this.getNamespace("-buttons")),jQuery.each(e,function(t){return function(e,i){i.id||(i.id=f());var s=t.createButton(i);n.append(s)}}(this))),n},n.prototype.init=function(){if(i.prototype.init.call(this),this.BPopoverOptions=t.extend(!0,{},t.fn.cityselect.defaultBPopoverOptions,h(this.$parent,"popover"),h(this.$element,"popover")),"function"!=typeof jQuery().popoverButton)throw new Error("popoverButton required");this.$output||(this.$output=this.createTarget(),this.BPopoverOptions.target=this.$output,this.$element.popoverButton(this.BPopoverOptions)),this.$output.isView=!0},n.prototype.updateTitle=function(){return this.$output.find(".tm-title").text(this.BPopoverOptions.title),this},n.prototype.updateContent=function(t){return this.$output.find(".popover-content").html("").append(t),this},n.prototype.updateButtons=function(t){return this.$output.find(".popover-footer").html("").append(t),this},n.prototype.showOutput=function(t){return this.updateTitle(),this.updateContent(this.createSettlementPopover(t.data)),this.updateButtons(this.createButtons()),this.$output.show(),this.$output.popoverX("refreshPosition"),i.prototype.showOutput.call(this,t)},n.prototype.hideOutput=function(t){return this.$output.hide(),i.prototype.hideOutput.call(this,t)},n.prototype.createSettlementPopover=function(e){return this.data=t.extend(!0,this.data,{data:JSON.stringify(e||{})}),this.$settlementWrapper=t("<div></div>").append(this.template.get("SettlementPopover","row",e)),this.$settlementWrapper.addClass(this.getNamespace("-settlement")),this.$settlement=this.$settlementWrapper.find("select"),this.$settlement},n.prototype.setAction=function(e){return i.prototype.setAction.call(this,e),setTimeout(function(){location.reload()}.bind(this),t.fn.cityselect.defaults.timeout)},n}(),t.fn.cityselect=function(){var e,n;return n=arguments[0],e=2<=arguments.length?c.call(arguments,1):[],this.each(function(){var i,o,a,c;if(i=t(this),!(a=i.data("citySelect"))){switch((o=i.closest(t.fn.cityselect.selectors.parent)).length<1&&(o=t("body")),(c=t.extend(!0,{},h(o),h(i))).mode){case"settlement.popover":default:a=new s(this,c)}a&&(i.data("citySelect",a),a.init())}if(void 0===n&&(n="getContent"),"string"==typeof n)return a[n].apply(a,e)})},t.fn.cityselect.CONTENT_SUCCESS="cityselect:content-success.cityselect",t.fn.cityselect.CONTENT_FAILURE="cityselect:content-failure.cityselect",t.fn.cityselect.defaults={ns:"cityselect",spinner:!0,buttons:!0,timeout:300,msg:{save:"сохранить",close:"закрыть"},cls:{save:"save btn-default",close:"remove btn-default"},settlement:{exclude:["автодорога","аллея","дачный поселок","заезд","километр","набережная","область","проспект","проезд","переулок","поселение","республика","район","сад","микрорайон","территория","тупик","улица"]}},t.fn.cityselect.selectors={main:"."+t.fn.cityselect.defaults.ns,parent:"."+t.fn.cityselect.defaults.ns+"-parent",output:"."+t.fn.cityselect.defaults.ns+"-output",data:"."+t.fn.cityselect.defaults.ns+"-data",actionBtn:"."+t.fn.cityselect.defaults.ns+"-action",actionClick:"[data-click]",actionMouseOver:"[data-mouseover]",actionWindowLoad:"[data-windowload]"},t.fn.cityselect.defaultBPopoverOptions={title:"title",content:"content",width:"200px"},t.fn.cityselect.defaultButtons={save:{action:"save"},close:{action:"close"}},t.fn.cityselect.template={SettlementPopover:{row:['<div class="form-group">','<div class="">','<select name="settlement" class="input-sm form-control">',"<option value=\"{kladr_id}\" data-settlement='{data}'>{name}</option>","</select>","</div>","</div>"]},get:function(e,n,i){if(this[e]&&this[e][n]){var s=this[e][n].join("");i=t.extend(!0,i||{},{_type:e,_name:n}),s=s.replace(new RegExp("{data}","g"),JSON.stringify(i));for(var o in i)s=s.replace(new RegExp("{"+o+"}","g"),i[o]);return s}return""}},t.fn.cityselect.methodActions={SettlementPopover:{show:{"settlement.selectize":function(){var n=this;this.$settlement.selectize({valueField:"kladr_id",labelField:"name",searchField:"name",create:!1,maxItems:1,loadThrottle:600,createOnBlur:!0,onFocus:function(){var t=this.$input.val();this.clear(),this.cityselect=this.options[t]},onChange:function(e){this.cityselect=this.options[e],n.data=t.extend(!0,n.data,{id:e,data:JSON.stringify(this.options[e]||{})})},onBlur:function(t){this.getValue().length<1&&this.cityselect&&this.setValue(this.cityselect.kladr_id)},load:function(i,s){if(i.length<2)return s();this.clearOptions(),t.ajax({url:e.actionUrl,type:"post",dataType:"json",cache:!1,data:t.extend(!0,n.options.params||{},{action:"settlement/getlist",query:i})}).done(function(e){return function(e){var n=[];e.data&&!e.data.error&&t.each(e.data,function(e,i){i.type&&(y(i.type,t.fn.cityselect.defaults.settlement.exclude)||n.push(i))}),s(n)}}()).fail(function(t){return function(t){console.log(t),s()}}())},render:{item:function(e,n){var i=this;return this.revertSettings.$children.each(function(){t.extend(i.options[this.value],h(t(this),"settlement"))}),['<div class="settlement-suggestion">','<div class="city">'+n(e.city),'<span class="text-muted" style="font-size: 0.7em; line-height: 1;"> ',n(e.city_type_full),e.region_with_type?", "+n(e.region_with_type):"",e.country?", "+n(e.country):"","</span>","</div>","</div>"].join("")},option:function(t,e){return['<div class="settlement-suggestion" style="padding: 5px 10px;">','<div class="city">'+e(t.city),'<span class="text-muted" style="font-size: 0.7em; line-height: 1;"> ',e(t.city_type_full),t.region_with_type?", "+e(t.region_with_type):"",t.country?", "+e(t.country):"","</span>","</div>","</div>"].join("")}}})}},hide:{}}},t(document).on("click",t.fn.cityselect.selectors.main+t.fn.cityselect.selectors.actionClick,function(e){var n=t(this);n.is("a")&&e.preventDefault(),n.cityselect()}),t(document).on("click",t.fn.cityselect.selectors.main+" "+t.fn.cityselect.selectors.actionBtn,function(e,n){var i,s,o,a;switch((i=t(this)).is("a")&&e.preventDefault(),s=i.data("button")||{},a=s.citySelect,o=s.action||i.data("action")){case"save":a.setAction(s.action);break;case"close":a.hideOutput();break;default:if("function"==typeof o)return o.call(i)}}),v.setup=function(){v.$doc=t(document),v.$win=t(window)},v.initialize=function(){v.setup()},v.initialize(),window.citySelect=v;var m=jQuery.fn.addClass;t.fn.addClass=function(){var e=m.apply(this,arguments);return t(this).trigger("cssClassChanged",arguments),e}}(window.jQuery,citySelectConfig);